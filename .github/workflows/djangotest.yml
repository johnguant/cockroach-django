name: Python package

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.5, 3.6, 3.7]

    steps:
    - uses: actions/checkout@v1
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install cockroach dependencies
      run: |
        sudo apt-get install -y libpq-dev
        pip3 install .
        
    - name: Install django dependencies
      run: |
        git clone --depth 1 --single-branch --branch cockroach-2.2.x https://github.com/timgraham/django _django_repo
        
        cd _django_repo/tests/
        pip3 install -e ..
        pip3 install -r requirements/py3.txt
        pip3 install -r requirements/postgres.txt
    - name: Run cockroach
      run: |
        wget "https://binaries.cockroachdb.com/cockroach-v19.2.0-rc.1.linux-amd64.tgz"
        tar -xvf cockroach-v19.2*
        cp cockroach-v19.2*/cockroach cockroach_exec
        ./cockroach_exec start --insecure --background
    - name: Run tests
      working-directory: _django_repo/tests/
      run: |
        pwd        
        cp ../../teamcity-build/cockroach_settings.py .
        python3 ../../teamcity-build/runtests.py
